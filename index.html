<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feasibility Media — Internal Admin Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Base theme variables */
    :root {
      --bg-primary: #111827; /* gray-900 */
      --bg-secondary: #1f2937; /* gray-800 */
      --bg-tertiary: #374151; /* gray-700 */
      --border-color: #4b5563; /* gray-600 */
      --text-primary: #f3f4f6; /* gray-200 */
      --text-secondary: #9ca3af; /* gray-400 */
      --accent-color: #4f46e5; /* indigo-600 */
    }

    /* General Styling */
    body { background-color: var(--bg-primary); color: var(--text-primary); }
    .modal-open { overflow: hidden; }
    .hidden-by-default { display: none; }
    .nav-link.active { background-color: var(--accent-color); color: white; }
    .table-header-sortable { cursor: pointer; user-select: none; transition: color .2s ease; }
    .table-header-sortable:hover { color: var(--text-primary); }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .animate-fadeIn { animation: fadeIn .3s ease-out forwards; }
    .animate-slideUp { animation: slideUp .3s ease-out forwards; }

    .modal .relative { animation: slideUp .3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }

    /* Custom Toast Notifications */
    #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 100; display: flex; flex-direction: column; gap: 0.75rem; }
    .toast {
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      color: white;
      font-weight: 500;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,.3), 0 4px 6px -2px rgba(0,0,0,.15);
      transform: translateX(120%);
      transition: transform .4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .toast.show { transform: translateX(0); }
    .toast.success { background-color: #16a34a; } /* green-600 */
    .toast.error { background-color: #dc2626; } /* red-600 */
  </style>
</head>
<body class="antialiased">

  <div id="toast-container"></div>

  <div id="app" class="min-h-screen flex">
    <aside class="w-72 bg-gray-900 text-gray-200 flex-shrink-0 flex flex-col">
      <div class="p-6 border-b border-gray-700">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center shadow-lg">
            <svg class="w-7 h-7 text-white" viewBox="0 0 24 24" fill="none"><path d="M3 12H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 3L19 7.5L12 12L5 7.5L12 3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <div>
            <h1 class="font-bold text-lg text-white">Feasibility Media</h1>
            <p class="text-xs text-gray-400">Internal Admin Portal</p>
          </div>
        </div>
      </div>

      <nav class="p-4 space-y-2 flex-1">
        <button data-section="dashboard" class="nav-link w-full flex items-center gap-3 px-4 py-2.5 rounded-md hover:bg-gray-700 transition-all duration-200">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M3 13h8V3H3v10zM13 21h8V11h-8v10zM13 3v6h8V3h-8zM3 21h8v-8H3v8z" stroke="currentColor" stroke-width="1.5"/></svg>
          <span>Dashboard</span>
        </button>
        <button data-section="projects" class="nav-link w-full flex items-center gap-3 px-4 py-2.5 rounded-md hover:bg-gray-700 transition-all duration-200">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M3 7h18M3 12h18M3 17h18" stroke="currentColor" stroke-width="1.5"/></svg>
          <span>Projects</span>
        </button>
        <button data-section="clients" class="nav-link w-full flex items-center gap-3 px-4 py-2.5 rounded-md hover:bg-gray-700 transition-all duration-200">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 100-10 5 5 0 000 10zM3 21a9 9 0 0118 0" stroke="currentColor" stroke-width="1.5"/></svg>
          <span>Clients</span>
        </button>
        <button data-section="freelancers" class="nav-link w-full flex items-center gap-3 px-4 py-2.5 rounded-md hover:bg-gray-700 transition-all duration-200">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path d="M12 12c2.5 0 4.5-2 4.5-4.5S14.5 3 12 3 7.5 5 7.5 7.5 9.5 12 12 12zM4.5 21v-1.5a4.5 4.5 0 014.5-4.5h6a4.5 4.5 0 014.5 4.5V21" stroke="currentColor" stroke-width="1.5"/></svg>
          <span>Freelancers</span>
        </button>
      </nav>

      <div class="p-4 border-t border-gray-700">
        <div class="text-xs text-gray-400">Logged in as</div>
        <div class="mt-1 text-sm font-semibold text-white">Admin • Feasibility</div>
      </div>
    </aside>

    <main class="flex-1 p-8 bg-gray-800">
      <div class="flex items-center justify-between mb-8">
        <h2 id="section-title" class="text-3xl font-bold text-white">Dashboard</h2>
        <div class="text-sm text-gray-400">Data persists in LocalStorage</div>
      </div>

      <section id="dashboard" class="section space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fadeIn">
          <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm text-gray-400">Total Revenue</div>
                <div id="total-revenue" class="text-3xl font-bold text-white mt-1">₹0.00</div>
              </div>
              <div class="p-3 bg-green-900/50 rounded-lg"><svg class="w-6 h-6 text-green-400" viewBox="0 0 24 24" fill="none"><path d="M3 12h18M3 6h18M3 18h18" stroke="currentColor" stroke-width="1.5"/></svg></div>
            </div>
          </div>
          <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm text-gray-400">Active Projects</div>
                <div id="active-projects" class="text-3xl font-bold text-white mt-1">0</div>
              </div>
              <div class="p-3 bg-yellow-900/50 rounded-lg"><svg class="w-6 h-6 text-yellow-400" viewBox="0 0 24 24" fill="none"><path d="M12 2v20M2 12h20" stroke="currentColor" stroke-width="1.5"/></svg></div>
            </div>
          </div>
          <div class="bg-gray-900 rounded-2xl p-6 border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm text-gray-400">Total Clients</div>
                <div id="total-clients" class="text-3xl font-bold text-white mt-1">0</div>
              </div>
              <div class="p-3 bg-indigo-900/50 rounded-lg"><svg class="w-6 h-6 text-indigo-400" viewBox="0 0 24 24" fill="none"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2m8-10a4 4 0 100-8 4 4 0 000 8zM23 21v-2a4 4 0 00-3-3.87" stroke="currentColor" stroke-width="1.5"/></svg></div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
          <div class="lg:col-span-3 bg-gray-900 rounded-2xl p-6 border border-gray-700 animate-fadeIn" style="animation-delay: 0.1s;">
            <h3 class="font-semibold text-white mb-4">Recent Activity</h3>
            <div id="recent-activity"></div>
          </div>
          <div class="lg:col-span-2 bg-gray-900 rounded-2xl p-6 border border-gray-700 animate-fadeIn" style="animation-delay: 0.2s;">
            <h3 class="font-semibold text-white mb-4">Projects by Status</h3>
            <div id="status-chart" class="space-y-3"></div>
          </div>
        </div>
      </section>

      <section id="projects" class="section hidden-by-default">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
          <input id="search-projects" type="search" placeholder="Search projects by service or client..." class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none w-full sm:w-72">
          <button id="add-project-btn" class="w-full sm:w-auto px-5 py-2.5 bg-indigo-600 text-white font-semibold rounded-md shadow-lg hover:bg-indigo-700 transition-all duration-200">+ Add New Project</button>
        </div>
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-700 overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="text-gray-400 border-b border-gray-700">
              <tr>
                <th class="p-3 table-header-sortable" data-sort="clientName">Client ⇅</th>
                <th class="p-3 table-header-sortable" data-sort="service">Service ⇅</th>
                <th class="p-3">Freelancer</th>
                <th class="p-3 table-header-sortable" data-sort="price">Price ⇅</th>
                <th class="p-3">Status</th>
                <th class="p-3 table-header-sortable" data-sort="dateAdded">Date Added ⇅</th>
                <th class="p-3 text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="projects-tbody" class="divide-y divide-gray-700"></tbody>
          </table>
        </div>
      </section>
      
      <section id="clients" class="section hidden-by-default">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
          <input id="search-clients" type="search" placeholder="Search clients by name or company..." class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-green-500 focus:outline-none w-full sm:w-72">
          <button id="add-client-btn" class="w-full sm:w-auto px-5 py-2.5 bg-green-600 text-white font-semibold rounded-md shadow-lg hover:bg-green-700 transition-all duration-200">+ Add New Client</button>
        </div>
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-700 overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="text-gray-400 border-b border-gray-700">
              <tr>
                <th class="p-3">Name</th><th class="p-3">Email</th><th class="p-3">Company</th><th class="p-3 text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="clients-tbody" class="divide-y divide-gray-700"></tbody>
          </table>
        </div>
      </section>
      
      <section id="freelancers" class="section hidden-by-default">
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
          <input id="search-freelancers" type="search" placeholder="Search freelancers by name..." class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-teal-500 focus:outline-none w-full sm:w-72">
          <button id="add-freelancer-btn" class="w-full sm:w-auto px-5 py-2.5 bg-teal-600 text-white font-semibold rounded-md shadow-lg hover:bg-teal-700 transition-all duration-200">+ Add New Freelancer</button>
        </div>
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-700 overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="text-gray-400 border-b border-gray-700">
              <tr><th class="p-3">Name</th><th class="p-3 text-right">Actions</th></tr>
            </thead>
            <tbody id="freelancers-tbody" class="divide-y divide-gray-700"></tbody>
          </table>
        </div>
      </section>

    </main>
  </div>

  <div id="client-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60" data-close-modal></div>
    <div class="relative w-full max-w-md bg-gray-800 rounded-xl shadow-2xl p-8 border border-gray-700">
      <h4 id="client-modal-title" class="text-xl font-bold text-white mb-6">Add Client</h4>
      <form id="client-form" class="space-y-4">
        <input type="hidden" id="client-id" />
        <div>
          <label class="text-sm font-medium text-gray-400">Name</label>
          <input required id="client-name" class="w-full mt-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-green-500 focus:outline-none" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-400">Email</label>
          <input required id="client-email" type="email" class="w-full mt-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-green-500 focus:outline-none" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-400">Company</label>
          <input required id="client-company" class="w-full mt-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-green-500 focus:outline-none" />
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" data-close-modal class="px-4 py-2 rounded-md border border-gray-600 text-gray-300 hover:bg-gray-700 transition">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition">Save Client</button>
        </div>
      </form>
    </div>
  </div>

  <div id="freelancer-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60" data-close-modal></div>
    <div class="relative w-full max-w-md bg-gray-800 rounded-xl shadow-2xl p-8 border border-gray-700">
      <h4 id="freelancer-modal-title" class="text-xl font-bold text-white mb-6">Add Freelancer</h4>
      <form id="freelancer-form" class="space-y-4">
        <input type="hidden" id="freelancer-id" />
        <div>
          <label class="text-sm font-medium text-gray-400">Name</label>
          <input required id="freelancer-name" class="w-full mt-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-teal-500 focus:outline-none" />
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" data-close-modal class="px-4 py-2 rounded-md border border-gray-600 text-gray-300 hover:bg-gray-700 transition">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-teal-600 text-white font-semibold rounded-md hover:bg-teal-700 transition">Save Freelancer</button>
        </div>
      </form>
    </div>
  </div>

  <div id="project-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4 overflow-y-auto">
    <div class="absolute inset-0 bg-black/60" data-close-modal></div>
    <div class="relative w-full max-w-2xl bg-gray-800 rounded-xl shadow-2xl p-8 border border-gray-700">
      <h4 id="project-modal-title" class="text-xl font-bold text-white mb-6">Add Project</h4>
      <form id="project-form" class="space-y-4">
        <input type="hidden" id="project-id" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-400">Client</label>
            <select required id="project-client" class="w-full mt-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none"></select>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-400">Assigned Freelancer</label>
            <select id="project-freelancer" class="w-full mt-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
              <option value="">— Unassigned —</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-400">Plan / Service</label>
            <input required id="project-service" class="w-full mt-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
          </div>
          <div>
            <label class="text-sm font-medium text-gray-400">Price (₹)</label>
            <input required id="project-price" type="number" min="0" step="0.01" class="w-full mt-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
          </div>
          <div>
            <label class="text-sm font-medium text-gray-400">Status</label>
            <select required id="project-status" class="w-full mt-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none">
              <option>New</option><option>In Progress</option><option>Pending Client Info</option><option>Internal Review</option><option>Delivered</option><option>Completed</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-400">Date Added</label>
            <input id="project-date" type="date" class="w-full mt-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
            <div class="text-xs text-gray-500 mt-1">Leave blank to use today's date.</div>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" data-close-modal class="px-4 py-2 rounded-md border border-gray-600 text-gray-300 hover:bg-gray-700 transition">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 transition">Save Project</button>
        </div>
      </form>
    </div>
  </div>

  <div id="confirm-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60" data-close-modal></div>
    <div class="relative w-full max-w-md bg-gray-800 rounded-xl shadow-2xl p-8 border border-gray-700">
      <h4 id="confirm-modal-title" class="text-xl font-bold text-white mb-2">Confirm Action</h4>
      <p id="confirm-modal-text" class="text-gray-400 mb-6">Are you sure you want to proceed?</p>
      <div class="flex justify-end gap-3">
        <button id="confirm-cancel-btn" type="button" class="px-4 py-2 rounded-md border border-gray-600 text-gray-300 hover:bg-gray-700 transition">Cancel</button>
        <button id="confirm-ok-btn" type="button" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 transition">Confirm</button>
      </div>
    </div>
  </div>

<script>
/*
  Feasibility Media — Single-file Admin Portal v2.0
  Enhancements: Dark theme, animations, search, sorting, charts, toast notifications, confirmation modals.
*/
(() => {
  // --- Utilities ---
  const LS_KEYS = { clients: 'fm_clients_v2', freelancers: 'fm_freelancers_v2', projects: 'fm_projects_v2' };
  function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 8); }
  function saveData(key, arr) { localStorage.setItem(key, JSON.stringify(arr || [])); }
  function loadData(key) {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : [];
    } catch (e) { return []; }
  }
  function money(num) { return (Number(num) || 0).toLocaleString('en-IN', { style: 'currency', currency: 'INR' }); }
  function escapeHtml(unsafe) {
    if (unsafe == null) return '';
    return String(unsafe).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
  }

  // --- State ---
  let clients = Array.isArray(loadData(LS_KEYS.clients)) ? loadData(LS_KEYS.clients) : [];
  let freelancers = Array.isArray(loadData(LS_KEYS.freelancers)) ? loadData(LS_KEYS.freelancers) : [];
  let projects = Array.isArray(loadData(LS_KEYS.projects)) ? loadData(LS_KEYS.projects) : [];
  let sortState = { key: 'dateAdded', direction: 'desc' };

  // --- DOM Refs ---
  const sectionTitle = document.getElementById('section-title');
  const addClientBtn = document.getElementById('add-client-btn'), clientModal = document.getElementById('client-modal'), clientForm = document.getElementById('client-form');
  const addFreelancerBtn = document.getElementById('add-freelancer-btn'), freelancerModal = document.getElementById('freelancer-modal'), freelancerForm = document.getElementById('freelancer-form');
  const addProjectBtn = document.getElementById('add-project-btn'), projectModal = document.getElementById('project-modal'), projectForm = document.getElementById('project-form');
  const confirmModal = document.getElementById('confirm-modal');
  const searchProjectsInput = document.getElementById('search-projects');
  const searchClientsInput = document.getElementById('search-clients');
  const searchFreelancersInput = document.getElementById('search-freelancers');

  // --- UI/UX Helpers (Toasts & Modals) ---
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
  }

  function openModal(modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    document.body.classList.add('modal-open');
  }
  function closeModal(modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    if (!document.querySelector('.modal.flex')) {
      document.body.classList.remove('modal-open');
    }
  }

  function showConfirmModal({ title, text, onConfirm }) {
    document.getElementById('confirm-modal-title').textContent = title;
    document.getElementById('confirm-modal-text').textContent = text;
    openModal(confirmModal);
    
    const confirmBtn = document.getElementById('confirm-ok-btn');
    const cancelBtn = document.getElementById('confirm-cancel-btn');

    const handleConfirm = () => {
      onConfirm();
      cleanup();
    };
    const cleanup = () => {
      closeModal(confirmModal);
      confirmBtn.removeEventListener('click', handleConfirm);
    };

    confirmBtn.addEventListener('click', handleConfirm, { once: true });
    cancelBtn.addEventListener('click', cleanup, { once: true });
  }

  // Event listeners for closing modals
  document.querySelectorAll('[data-close-modal], #confirm-cancel-btn').forEach(el => {
    el.addEventListener('click', (e) => closeModal(e.target.closest('.modal')));
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('.modal').forEach(m => closeModal(m));
    }
  });

  // --- Navigation ---
  function setActiveSection(name) {
    document.querySelectorAll('.section').forEach(s => s.id === name ? s.classList.remove('hidden-by-default') : s.classList.add('hidden-by-default'));
    document.querySelectorAll('.nav-link').forEach(n => n.dataset.section === name ? n.classList.add('active') : n.classList.remove('active'));
    sectionTitle.textContent = name.charAt(0).toUpperCase() + name.slice(1);
    renderAll();
  }
  document.querySelectorAll('.nav-link').forEach(n => n.addEventListener('click', () => setActiveSection(n.dataset.section)));

  // --- Data & Rendering ---
  function persistAll() {
    saveData(LS_KEYS.clients, clients);
    saveData(LS_KEYS.freelancers, freelancers);
    saveData(LS_KEYS.projects, projects);
  }

  function renderAll() {
    renderClients();
    renderFreelancers();
    renderProjects();
    renderDashboard();
  }

  const statusColors = {
    'New': 'bg-blue-900/50 text-blue-300 border border-blue-500/30',
    'In Progress': 'bg-yellow-900/50 text-yellow-300 border border-yellow-500/30',
    'Pending Client Info': 'bg-orange-900/50 text-orange-300 border border-orange-500/30',
    'Internal Review': 'bg-purple-900/50 text-purple-300 border border-purple-500/30',
    'Delivered': 'bg-teal-900/50 text-teal-300 border border-teal-500/30',
    'Completed': 'bg-gray-700 text-gray-400 border border-gray-600'
  };

  // Clients
  function renderClients(filteredClients = clients) {
    const tbody = document.getElementById('clients-tbody');
    tbody.innerHTML = '';
    if (filteredClients.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">No clients found.</td></tr>`;
      return;
    }
    filteredClients.forEach(c => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-800/50 animate-fadeIn';
      tr.innerHTML = `
        <td class="p-3 font-medium">${escapeHtml(c.name)}</td>
        <td class="p-3 text-gray-400">${escapeHtml(c.email)}</td>
        <td class="p-3 text-gray-400">${escapeHtml(c.company)}</td>
        <td class="p-3 text-right">
          <div class="flex gap-2 justify-end">
            <button data-id="${c.id}" class="edit-client px-3 py-1.5 bg-yellow-600/20 text-yellow-300 rounded-md text-xs font-semibold hover:bg-yellow-600/40">Edit</button>
            <button data-id="${c.id}" class="delete-client px-3 py-1.5 bg-red-600/20 text-red-300 rounded-md text-xs font-semibold hover:bg-red-600/40">Delete</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });
    // Attach handlers
    tbody.querySelectorAll('.edit-client').forEach(btn => btn.addEventListener('click', handleEditClient));
    tbody.querySelectorAll('.delete-client').forEach(btn => btn.addEventListener('click', handleDeleteClient));
  }

  // Freelancers
  function renderFreelancers(filteredFreelancers = freelancers) {
    const tbody = document.getElementById('freelancers-tbody');
    tbody.innerHTML = '';
    if (filteredFreelancers.length === 0) {
      tbody.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-gray-500">No freelancers found.</td></tr>`;
      return;
    }
    filteredFreelancers.forEach(f => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-800/50 animate-fadeIn';
      tr.innerHTML = `
        <td class="p-3 font-medium">${escapeHtml(f.name)}</td>
        <td class="p-3 text-right">
          <div class="flex gap-2 justify-end">
            <button data-id="${f.id}" class="edit-freelancer px-3 py-1.5 bg-yellow-600/20 text-yellow-300 rounded-md text-xs font-semibold hover:bg-yellow-600/40">Edit</button>
            <button data-id="${f.id}" class="delete-freelancer px-3 py-1.5 bg-red-600/20 text-red-300 rounded-md text-xs font-semibold hover:bg-red-600/40">Delete</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });
    // Attach handlers
    tbody.querySelectorAll('.edit-freelancer').forEach(btn => btn.addEventListener('click', handleEditFreelancer));
    tbody.querySelectorAll('.delete-freelancer').forEach(btn => btn.addEventListener('click', handleDeleteFreelancer));
  }

  // Projects
  function renderProjects(filteredProjects = projects) {
    const tbody = document.getElementById('projects-tbody');
    tbody.innerHTML = '';

    // Sort projects
    const sorted = [...filteredProjects].sort((a, b) => {
        const valA = sortState.key === 'clientName' ? (clients.find(c => c.id === a.clientId) || {}).name || '' : a[sortState.key];
        const valB = sortState.key === 'clientName' ? (clients.find(c => c.id === b.clientId) || {}).name || '' : b[sortState.key];
        if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
        if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    if (sorted.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">No projects found.</td></tr>`;
      return;
    }

    sorted.forEach(p => {
      const client = clients.find(c => c.id === p.clientId);
      const freelancer = freelancers.find(f => f.id === p.freelancerId);
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-800/50 animate-fadeIn';
      tr.innerHTML = `
        <td class="p-3 font-medium">${escapeHtml(client?.name || '— Removed —')}</td>
        <td class="p-3 text-gray-300">${escapeHtml(p.service)}</td>
        <td class="p-3 text-gray-400">${escapeHtml(freelancer?.name || '— Unassigned —')}</td>
        <td class="p-3 text-gray-300">${money(p.price)}</td>
        <td class="p-3"><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${statusColors[p.status] || ''}">${p.status}</span></td>
        <td class="p-3 text-gray-400">${new Date(p.dateAdded).toLocaleDateString()}</td>
        <td class="p-3 text-right">
          <div class="flex gap-2 justify-end">
            <button data-id="${p.id}" class="edit-project px-3 py-1.5 bg-yellow-600/20 text-yellow-300 rounded-md text-xs font-semibold hover:bg-yellow-600/40">Edit</button>
            <button data-id="${p.id}" class="delete-project px-3 py-1.5 bg-red-600/20 text-red-300 rounded-md text-xs font-semibold hover:bg-red-600/40">Delete</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });
    // Attach handlers
    tbody.querySelectorAll('.edit-project').forEach(btn => btn.addEventListener('click', handleEditProject));
    tbody.querySelectorAll('.delete-project').forEach(btn => btn.addEventListener('click', handleDeleteProject));
  }
  
  // Sorting for projects
  document.querySelectorAll('.table-header-sortable').forEach(header => {
    header.addEventListener('click', () => {
        const key = header.dataset.sort;
        if (sortState.key === key) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.key = key;
            sortState.direction = 'asc';
        }
        renderProjects();
    });
  });

  // Dashboard
  function renderDashboard() {
    document.getElementById('total-revenue').textContent = money(projects.reduce((s, p) => s + (Number(p.price) || 0), 0));
    document.getElementById('active-projects').textContent = projects.filter(p => p.status !== 'Completed').length;
    document.getElementById('total-clients').textContent = clients.length;

    // Recent Activity
    const recentActivityEl = document.getElementById('recent-activity');
    recentActivityEl.innerHTML = '';
    const sortedProjects = [...projects].sort((a,b) => new Date(b.dateAdded) - new Date(a.dateAdded)).slice(0,5);
    if (sortedProjects.length === 0) {
      recentActivityEl.innerHTML = '<div class="text-gray-500 py-3 text-center">No recent projects.</div>';
    } else {
      const ul = document.createElement('ul');
      ul.className = 'space-y-3';
      sortedProjects.forEach(p => {
        const client = clients.find(c => c.id === p.clientId);
        ul.innerHTML += `
          <li class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg">
            <div>
              <div class="font-medium text-gray-200">${escapeHtml(client?.name || '— Removed —')}</div>
              <div class="text-sm text-gray-400">${escapeHtml(p.service)}</div>
            </div>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${statusColors[p.status] || ''}">${p.status}</span>
          </li>`;
      });
      recentActivityEl.appendChild(ul);
    }
    
    // Status Chart
    const statusChartEl = document.getElementById('status-chart');
    statusChartEl.innerHTML = '';
    const statusCounts = projects.reduce((acc, p) => {
        acc[p.status] = (acc[p.status] || 0) + 1;
        return acc;
    }, {});

    if (Object.keys(statusCounts).length === 0) {
        statusChartEl.innerHTML = '<div class="text-gray-500 py-3 text-center">No project data for chart.</div>';
    } else {
        const total = projects.length;
        Object.keys(statusColors).forEach(status => {
            const count = statusCounts[status] || 0;
            const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
            statusChartEl.innerHTML += `
            <div>
              <div class="flex justify-between items-center text-sm mb-1">
                <span class="font-medium text-gray-300">${status}</span>
                <span class="text-gray-400">${count} (${percentage}%)</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-2">
                <div class="${(statusColors[status] || '').split(' ')[0]} h-2 rounded-full" style="width: ${percentage}%"></div>
              </div>
            </div>`;
        });
    }
  }

  // --- Form & Action Handlers ---
  function handleEditClient(e) {
    const client = clients.find(c => c.id === e.target.dataset.id);
    if (!client) return showToast('Client not found.', 'error');
    document.getElementById('client-modal-title').textContent = 'Edit Client';
    const form = clientForm;
    form['client-id'].value = client.id;
    form['client-name'].value = client.name;
    form['client-email'].value = client.email;
    form['client-company'].value = client.company;
    openModal(clientModal);
  }
  function handleDeleteClient(e) {
    const client = clients.find(c => c.id === e.target.dataset.id);
    if (!client) return showToast('Client not found.', 'error');
    showConfirmModal({
        title: `Delete Client: ${client.name}`,
        text: 'This will also delete all associated projects. This action cannot be undone.',
        onConfirm: () => {
            clients = clients.filter(c => c.id !== client.id);
            projects = projects.filter(p => p.clientId !== client.id);
            persistAll();
            renderAll();
            showToast('Client and associated projects deleted.');
        }
    });
  }
  function handleEditFreelancer(e) {
    const f = freelancers.find(x => x.id === e.target.dataset.id);
    if (!f) return showToast('Freelancer not found.', 'error');
    document.getElementById('freelancer-modal-title').textContent = 'Edit Freelancer';
    const form = freelancerForm;
    form['freelancer-id'].value = f.id;
    form['freelancer-name'].value = f.name;
    openModal(freelancerModal);
  }
  function handleDeleteFreelancer(e) {
    const f = freelancers.find(x => x.id === e.target.dataset.id);
    if (!f) return showToast('Freelancer not found.', 'error');
    showConfirmModal({
        title: `Delete Freelancer: ${f.name}`,
        text: 'Projects will be unassigned, not deleted. Are you sure?',
        onConfirm: () => {
            freelancers = freelancers.filter(x => x.id !== f.id);
            projects = projects.map(p => p.freelancerId === f.id ? { ...p, freelancerId: '' } : p);
            persistAll();
            renderAll();
            showToast('Freelancer deleted.');
        }
    });
  }
  function handleEditProject(e) {
    const p = projects.find(x => x.id === e.target.dataset.id);
    if (!p) return showToast('Project not found.', 'error');
    document.getElementById('project-modal-title').textContent = 'Edit Project';
    fillProjectFormOptions();
    const form = projectForm;
    form['project-id'].value = p.id;
    form['project-client'].value = p.clientId || '';
    form['project-freelancer'].value = p.freelancerId || '';
    form['project-service'].value = p.service;
    form['project-price'].value = p.price;
    form['project-status'].value = p.status;
    form['project-date'].value = new Date(p.dateAdded).toISOString().slice(0,10);
    openModal(projectModal);
  }
  function handleDeleteProject(e) {
    const p = projects.find(x => x.id === e.target.dataset.id);
    if (!p) return showToast('Project not found.', 'error');
    showConfirmModal({
        title: `Delete Project?`,
        text: `Are you sure you want to delete the project "${p.service}"?`,
        onConfirm: () => {
            projects = projects.filter(x => x.id !== p.id);
            persistAll();
            renderAll();
            showToast('Project deleted.');
        }
    });
  }

  // --- Search ---
  searchProjectsInput.addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = projects.filter(p => {
        const client = clients.find(c => c.id === p.clientId);
        return p.service.toLowerCase().includes(term) || (client && client.name.toLowerCase().includes(term));
    });
    renderProjects(filtered);
  });
  searchClientsInput.addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = clients.filter(c => c.name.toLowerCase().includes(term) || c.company.toLowerCase().includes(term));
    renderClients(filtered);
  });
  searchFreelancersInput.addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = freelancers.filter(f => f.name.toLowerCase().includes(term));
    renderFreelancers(filtered);
  });

  // --- Add Buttons ---
  addClientBtn.addEventListener('click', () => {
    document.getElementById('client-modal-title').textContent = 'Add Client';
    clientForm.reset();
    clientForm['client-id'].value = '';
    openModal(clientModal);
  });
  addFreelancerBtn.addEventListener('click', () => {
    document.getElementById('freelancer-modal-title').textContent = 'Add Freelancer';
    freelancerForm.reset();
    freelancerForm['freelancer-id'].value = '';
    openModal(freelancerModal);
  });
  addProjectBtn.addEventListener('click', () => {
    document.getElementById('project-modal-title').textContent = 'Add Project';
    projectForm.reset();
    projectForm['project-id'].value = '';
    fillProjectFormOptions();
    openModal(projectModal);
  });

  // --- Form Submissions ---
  clientForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const id = e.target['client-id'].value;
    const clientData = {
      name: e.target['client-name'].value.trim(),
      email: e.target['client-email'].value.trim(),
      company: e.target['client-company'].value.trim(),
    };
    if (id) {
      const idx = clients.findIndex(c => c.id === id);
      if (idx > -1) clients[idx] = { ...clients[idx], ...clientData };
    } else {
      clients.push({ id: uid(), ...clientData });
    }
    persistAll();
    renderAll();
    closeModal(clientModal);
    showToast(`Client ${id ? 'updated' : 'saved'} successfully!`);
  });

  freelancerForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const id = e.target['freelancer-id'].value;
    const name = e.target['freelancer-name'].value.trim();
    if (id) {
      const idx = freelancers.findIndex(f => f.id === id);
      if (idx > -1) freelancers[idx].name = name;
    } else {
      freelancers.push({ id: uid(), name });
    }
    persistAll();
    renderAll();
    closeModal(freelancerModal);
    showToast(`Freelancer ${id ? 'updated' : 'saved'} successfully!`);
  });

  function fillProjectFormOptions() {
    const clientSelect = document.getElementById('project-client');
    clientSelect.innerHTML = '<option value="">— Select client —</option>';
    clients.forEach(c => clientSelect.innerHTML += `<option value="${c.id}">${escapeHtml(c.name)} • ${escapeHtml(c.company)}</option>`);
    const freelancerSelect = document.getElementById('project-freelancer');
    freelancerSelect.innerHTML = '<option value="">— Unassigned —</option>';
    freelancers.forEach(f => freelancerSelect.innerHTML += `<option value="${f.id}">${escapeHtml(f.name)}</option>`);
  }

  projectForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const id = e.target['project-id'].value;
    const projectData = {
      clientId: e.target['project-client'].value,
      freelancerId: e.target['project-freelancer'].value,
      service: e.target['project-service'].value.trim(),
      price: parseFloat(e.target['project-price'].value) || 0,
      status: e.target['project-status'].value,
      dateAdded: e.target['project-date'].value ? new Date(e.target['project-date'].value).toISOString() : new Date().toISOString(),
    };
    if (!projectData.clientId || !projectData.service) return showToast('Client and Service are required.', 'error');
    
    if (id) {
      const idx = projects.findIndex(p => p.id === id);
      if (idx > -1) projects[idx] = { ...projects[idx], ...projectData };
    } else {
      projects.push({ id: uid(), ...projectData });
    }
    persistAll();
    renderAll();
    closeModal(projectModal);
    showToast(`Project ${id ? 'updated' : 'saved'} successfully!`);
  });

  // --- Initial Load ---
  setActiveSection('dashboard');
})();
</script>
</body>
</html>
